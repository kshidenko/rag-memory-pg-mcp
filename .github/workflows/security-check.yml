name: Security Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    name: Check for leaked secrets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for secrets in code
        run: |
          # Check for common secret patterns
          echo "üîç Scanning for potential secrets..."
          
          # Check for API keys
          if grep -rE "(sk-proj-[A-Za-z0-9]{20,}|sk-[A-Za-z0-9]{20,})" --exclude-dir=node_modules --exclude-dir=.git . ; then
            echo "‚ùå Found OpenAI API key!"
            exit 1
          fi
          
          # Check for JWT tokens
          if grep -r "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\.eyJ" --exclude-dir=node_modules --exclude-dir=.git . ; then
            echo "‚ùå Found JWT token!"
            exit 1
          fi
          
          # Check for Supabase project IDs
          if grep -r "supabase\.co" --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md" --exclude=".env.example" . ; then
            echo "‚ùå Found Supabase URL in code!"
            exit 1
          fi
          
          echo "‚úÖ No secrets detected"

      - name: Check .env files not committed
        run: |
          if [ -f .env ] || [ -f .env.local ]; then
            echo "‚ùå .env file found in repository!"
            exit 1
          fi
          echo "‚úÖ No .env files committed"
